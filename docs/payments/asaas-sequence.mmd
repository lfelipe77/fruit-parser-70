sequenceDiagram
    participant U as User
    participant FC as Frontend<br/>(ConfirmacaoPagamento)
    participant SB as Supabase<br/>(RPC)
    participant EF1 as Edge Function<br/>(asaas-payments-complete)
    participant AS as Asaas API
    participant EF2 as Edge Function<br/>(payment-status)
    participant EF3 as Edge Function<br/>(payment-finalize)
    participant FS as Frontend<br/>(PagamentoSucesso)

    Note over U,FS: 1. Ticket Reservation Phase
    U->>FC: Fill form (CPF, name, phone)
    FC->>FC: Validate CPF with normalizeCPFForAsaas()
    FC->>SB: rpc('reserve_tickets_v2', {raffle_id, qty})
    SB-->>FC: {reservation_id, expires_at, unit_price, total_amount}

    Note over U,FS: 2. PIX Payment Creation Phase
    FC->>EF1: POST /asaas-payments-complete<br/>{reservationId, value, customer}
    EF1->>EF1: Validate JWT & get user profile
    EF1->>EF1: Validate CPF (strict/loose mode)
    EF1->>AS: POST /customers<br/>{name, cpfCnpj, personType, email}
    AS-->>EF1: {id: customer_id}
    EF1->>AS: POST /payments<br/>{customer, value, billingType: 'PIX'}
    AS-->>EF1: {id: payment_id, invoiceUrl}
    EF1->>AS: GET /payments/{payment_id}/pixQrCode
    AS-->>EF1: {encodedImage, payload, expiresAt}
    EF1->>SB: INSERT payments_pending<br/>{reservation_id, asaas_payment_id, amount}
    EF1-->>FC: {ok: true, qrCode, payload, paymentId, expiresAt}

    Note over U,FS: 3. PIX Display & Payment Phase
    FC->>FC: Show PIX modal with QR code
    FC->>FC: Start polling timer (10s interval)
    U->>U: Scan QR code & pay via bank app
    U->>AS: PIX payment (external)
    AS->>AS: Update payment status to RECEIVED/CONFIRMED

    Note over U,FS: 4. Payment Status Polling Phase
    loop Every 10 seconds (max 60 attempts)
        FC->>EF2: GET /payment-status?reservationId={id}
        EF2->>EF2: Validate JWT & ownership
        EF2->>SB: SELECT payments_pending WHERE reservation_id
        EF2->>AS: GET /payments/{payment_id}
        AS-->>EF2: {status: 'RECEIVED'}
        alt Payment is RECEIVED/CONFIRMED
            EF2->>EF3: Call finalize_paid_purchase RPC
            EF3->>SB: INSERT transactions<br/>UPDATE tickets status to 'paid'
            EF2-->>FC: {status: 'PAID', reservationId, paymentId}
            FC->>FC: Stop polling
            FC->>FS: Navigate to success page
        else Payment still pending
            EF2-->>FC: {status: 'PENDING', asaasStatus}
            FC->>FC: Continue polling
        end
    end

    Note over U,FS: 5. Payment Confirmation Phase
    FS->>SB: rpc('get_reservation_audit', {reservation_id})
    SB-->>FS: {all_paid, ticket_count, amount}
    alt Payment finalized
        FS->>SB: rpc('purchase_summary_by_reservation', {reservation_id})
        SB-->>FS: {transaction_id, numbers, amount, provider}
    else Payment not finalized
        FS->>SB: rpc('purchase_preview_by_reservation', {reservation_id})
        SB-->>FS: {numbers, total_amount, qty}
    end
    FS->>FS: Display success message & ticket details
    U->>FS: View ticket numbers & copy to clipboard